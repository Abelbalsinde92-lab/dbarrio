<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>dbarrio — recuperar acceso</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;max-width:520px;margin:40px auto;padding:0 16px}
    h1{margin:0 0 14px}
    p{color:#555}
    input{width:100%;padding:12px 14px;margin:8px 0;border:1px solid #ddd;border-radius:10px;font-size:16px}
    button{width:100%;padding:12px 14px;border:0;border-radius:10px;font-size:16px;font-weight:700;cursor:pointer}
    button:disabled{opacity:.5;cursor:not-allowed}
    .ok{color:#0a7a3d;margin-top:10px}
    .err{color:#c62828;margin-top:10px}
  </style>
</head>
<body>
  <h1>Recuperar acceso</h1>
  <p id="sub">Verificando enlace…</p>

  <input id="p1" type="password" placeholder="Nueva contraseña (mín 6)" />
  <input id="p2" type="password" placeholder="Repite la contraseña" />
  <button id="btnSave" onclick="save()" disabled>Guardar</button>

  <div id="msg"></div>

<script>
  const SURL = 'https://gkxtdancgkwetdniooky.supabase.co';
  const SKEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdreHRkYW5jZ2t3ZXRkbmlvb2t5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxOTQ1OTksImV4cCI6MjA4Nzc3MDU5OX0.QFEZQPUkPqg1Nu7LchoSfsMK96DKzE5pTnzqrQXMVYs';
  const sb = supabase.createClient(SURL, SKEY);

  document.addEventListener('DOMContentLoaded', init);

  function show(text, ok=false){
    const m=document.getElementById('msg');
    m.className = ok ? 'ok' : 'err';
    m.textContent = text;
  }

  function setSub(text){
    const s=document.getElementById('sub');
    if(s) s.textContent = text;
  }

  // Lee tokens del hash: #access_token=...&refresh_token=...
  function readHashTokens(){
    const hash = window.location.hash || '';
    if(!hash.startsWith('#')) return null;
    const p = new URLSearchParams(hash.slice(1));
    const access_token = p.get('access_token');
    const refresh_token = p.get('refresh_token');
    if(access_token && refresh_token) return { access_token, refresh_token };
    return null;
  }

  async function init(){
    const btn = document.getElementById('btnSave');
    if (btn) btn.disabled = true;

    const url = new URL(window.location.href);
    const code = url.searchParams.get('code');

    try {
      // 1) PKCE: ?code=...
      if (code) {
        const { error } = await sb.auth.exchangeCodeForSession(window.location.href);
        if (error) {
          setSub('Enlace inválido');
          return show('Link inválido o expirado. Pide recuperar contraseña otra vez.');
        }
        setSub('Enlace verificado. Crea tu nueva contraseña.');
        if (btn) btn.disabled = false;
        return;
      }

      // 2) Implicit: #access_token=...
      const t = readHashTokens();
      if (t) {
        const { error } = await sb.auth.setSession({
          access_token: t.access_token,
          refresh_token: t.refresh_token
        });
        if (error) {
          setSub('Enlace inválido');
          return show('Link inválido o expirado. Pide recuperar contraseña otra vez.');
        }
        setSub('Enlace verificado. Crea tu nueva contraseña.');
        if (btn) btn.disabled = false;
        return;
      }

      // 3) Si no hay code ni hash, mira si hay sesión ya
      const { data: { session } } = await sb.auth.getSession();
      if (!session) {
        setSub('No hay sesión de recuperación');
        return show('No hay sesión de recuperación en este enlace. Abre el link desde Safari o pide uno nuevo.');
      }

      setSub('Sesión lista. Crea tu nueva contraseña.');
      if (btn) btn.disabled = false;

    } catch (e) {
      setSub('Error');
      show('Error inesperado. Intenta abrir el enlace en Safari.');
    }
  }

  async function save(){
    const p1=document.getElementById('p1').value;
    const p2=document.getElementById('p2').value;

    if(p1.length<6) return show('La contraseña debe tener al menos 6 caracteres.');
    if(p1!==p2) return show('Las contraseñas no coinciden.');

    const { data: { session } } = await sb.auth.getSession();
    if(!session) return show('Sesión no válida. Abre el enlace desde Safari o pide uno nuevo.');

    const { error } = await sb.auth.updateUser({ password: p1 });
    if(error) return show('Error: ' + error.message);

    show('Contraseña actualizada. Ya puedes iniciar sesión.', true);
    setTimeout(()=>{ window.location.href='index.html'; }, 900);
  }
</script>
</body>
</html>