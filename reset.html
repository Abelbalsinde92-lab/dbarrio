<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>dbarrio ‚Äî recuperar acceso</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;max-width:520px;margin:40px auto;padding:0 16px}
    h1{margin:0 0 14px}
    p{color:#555}
    input{width:100%;padding:12px 14px;margin:8px 0;border:1px solid #ddd;border-radius:10px;font-size:16px}
    button{width:100%;padding:12px 14px;border:0;border-radius:10px;font-size:16px;font-weight:700;cursor:pointer}
    .ok{color:#0a7a3d;margin-top:10px}
    .err{color:#c62828;margin-top:10px}
  </style>
</head>
<body>
  <h1>Recuperar acceso</h1>
  <p>Introduce tu nueva contrase√±a.</p>

  <input id="p1" type="password" placeholder="Nueva contrase√±a (m√≠n 6)" />
  <input id="p2" type="password" placeholder="Repite la contrase√±a" />
  <button onclick="save()">Guardar</button>

  <div id="msg"></div>

<script>
  const SURL = 'https://gkxtdancgkwetdniooky.supabase.co';
  const SKEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdreHRkYW5jZ2t3ZXRkbmlvb2t5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxOTQ1OTksImV4cCI6MjA4Nzc3MDU5OX0.QFEZQPUkPqg1Nu7LchoSfsMK96DKzE5pTnzqrQXMVYs';
  const sb = supabase.createClient(SURL, SKEY);
<script>
  const SURL = 'https://gkxtdancgkwetdniooky.supabase.co';
  const SKEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdreHRkYW5jZ2t3ZXRkbmlvb2t5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxOTQ1OTksImV4cCI6MjA4Nzc3MDU5OX0.QFEZQPUkPqg1Nu7LchoSfsMK96DKzE5pTnzqrQXMVYs';
  const sb = supabase.createClient(SURL, SKEY);

  // üëá NUEVO: al cargar, intenta crear sesi√≥n desde el link del email
  document.addEventListener('DOMContentLoaded', init);

  function show(text, ok=false){
    const m=document.getElementById('msg');
    m.className = ok ? 'ok' : 'err';
    m.textContent = text;
  }

  // üëá NUEVO: helper para leer el hash (#access_token=...)
  function readHashTokens(){
    const hash = window.location.hash || '';
    if(!hash.startsWith('#')) return null;
    const p = new URLSearchParams(hash.slice(1));
    const access_token = p.get('access_token');
    const refresh_token = p.get('refresh_token');
    if(access_token && refresh_token) return { access_token, refresh_token };
    return null;
  }

  // üëá NUEVO: prepara la sesi√≥n temporal (PKCE o hash tokens)
  async function init(){
    // 1) Si viene como ?code=...
    const url = new URL(window.location.href);
    const code = url.searchParams.get('code');

    try {
      if (code) {
        // PKCE flow
        const { error } = await sb.auth.exchangeCodeForSession(window.location.href);
        if (error) return show('Link inv√°lido o expirado. Pide recuperar contrase√±a otra vez.');
        show('Link verificado. Ya puedes poner tu nueva contrase√±a.', true);
        return;
      }

      // 2) Si viene como #access_token=...
      const t = readHashTokens();
      if (t) {
        const { error } = await sb.auth.setSession({
          access_token: t.access_token,
          refresh_token: t.refresh_token
        });
        if (error) return show('Link inv√°lido o expirado. Pide recuperar contrase√±a otra vez.');
        show('Link verificado. Ya puedes poner tu nueva contrase√±a.', true);
        return;
      }

      // 3) Si no hay nada, revisa si ya hay sesi√≥n (por si acaso)
      const { data: { session } } = await sb.auth.getSession();
      if (!session) {
        show('No hay sesi√≥n de recuperaci√≥n en este enlace. Abre el link desde Safari o pide uno nuevo.');
      } else {
        show('Sesi√≥n lista. Ya puedes cambiar tu contrase√±a.', true);
      }
    } catch (e) {
      show('Error inesperado. Intenta abrir el enlace en Safari.');
    }
  }

  async function save(){
    const p1=document.getElementById('p1').value;
    const p2=document.getElementById('p2').value;
    if(p1.length<6) return show('La contrase√±a debe tener al menos 6 caracteres.');
    if(p1!==p2) return show('Las contrase√±as no coinciden.');

    // üëá (opcional pero recomendado) valida que hay sesi√≥n antes de actualizar
    const { data: { session } } = await sb.auth.getSession();
    if(!session) return show('Sesi√≥n no v√°lida. Abre el enlace desde Safari o pide uno nuevo.');

    const { error } = await sb.auth.updateUser({ password: p1 });
    if(error) return show('Error: ' + error.message);

    show('Contrase√±a actualizada. Ya puedes iniciar sesi√≥n.', true);
    setTimeout(()=>{ window.location.href='index.html'; }, 1200);
  }
</script>
  function show(text, ok=false){
    const m=document.getElementById('msg');
    m.className = ok ? 'ok' : 'err';
    m.textContent = text;
  }

  async function save(){
    const p1=document.getElementById('p1').value;
    const p2=document.getElementById('p2').value;
    if(p1.length<6) return show('La contrase√±a debe tener al menos 6 caracteres.');
    if(p1!==p2) return show('Las contrase√±as no coinciden.');

    // Si llegaste aqu√≠ desde el link de recovery, supabase ya trae la sesi√≥n temporal
    const { data, error } = await sb.auth.updateUser({ password: p1 });
    if(error) return show('Error: ' + error.message);

    show('Contrase√±a actualizada. Ya puedes iniciar sesi√≥n.', true);
    setTimeout(()=>{ window.location.href='index.html'; }, 1200);
  }
</script>
</body>
</html>
